// @ts-check
"use strict";

/**
 * Fast TIFF Processor using WebAssembly
 * 
 * This module provides a high-performance TIFF decoder using Rust/WebAssembly.
 * It can be used as a drop-in replacement for geotiff.js for faster loading.
 */

let wasmModule = null;
let wasmInitPromise = null;

/**
 * Initialize the WASM module
 * @returns {Promise\u003cany\u003e}
 */
async function initWasm() {
    if (wasmModule) {
        return wasmModule;
    }

    if (wasmInitPromise) {
        return wasmInitPromise;
    }

    wasmInitPromise = (async () => {
        try {
            // Import the JS bindings generated by wasm-pack
            // Use relative path for VS Code webview compatibility
            const { default: init, decode_tiff } = await import('../wasm/tiff-wasm.js');

            // Initialize the WASM module
            await init();

            wasmModule = { decode_tiff };
            return wasmModule;
        } catch (error) {
            console.warn('Failed to load WASM module, will use geotiff.js fallback:', error);
            return null;
        }
    })();

    return wasmInitPromise;
}

/**
 * @typedef {Object} TiffDecodeResult
 * @property {number} width
 * @property {number} height
 * @property {number} channels
 * @property {number} bitsPerSample
 * @property {number} sampleFormat - 1=uint, 2=int, 3=float
 * @property {Float32Array} data - Pixel data as floats
 * @property {number} min - Minimum value
 * @property {number} max - Maximum value
 */

/**
 * Fast TIFF Processor class using WASM
 */
export class TiffWasmProcessor {
    constructor() {
        /** @type {any} */
        this.wasm = null;
    }

    /**
     * Initialize the WASM module
     * @returns {Promise\u003cboolean\u003e} - True if WASM loaded, false if falling back to JS
     */
    async init() {
        this.wasm = await initWasm();
        return this.wasm !== null;
    }

    /**
     * Check if WASM is available
     * @returns {boolean}
     */
    isAvailable() {
        return this.wasm !== null;
    }

    /**
     * Decode a TIFF file from an ArrayBuffer
     * @param {ArrayBuffer} buffer - TIFF file data
     * @returns {Promise\u003cTiffDecodeResult\u003e}
     */
    async decode(buffer) {
        if (!this.wasm) {
            throw new Error('WASM not initialized. Call init() first.');
        }

        const uint8Array = new Uint8Array(buffer);
        const result = this.wasm.decode_tiff(uint8Array);

        const decodeResult = {
            width: result.width,
            height: result.height,
            channels: result.channels,
            bitsPerSample: result.bits_per_sample,
            sampleFormat: result.sample_format,
            data: new Float32Array(result.get_data_as_f32()),
            min: result.min_value,
            max: result.max_value
        };

        return decodeResult;
    }
}

// Export for use
export { initWasm };
