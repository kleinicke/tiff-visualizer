// Fixed ESM script to properly bundle parse-exr for browser
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

console.log('Bundling parse-exr for browser (fixed version)...');

const fflatePath = path.join(__dirname, '../node_modules/fflate/esm/browser.js');
const parseExrPath = path.join(__dirname, '../node_modules/parse-exr/index.js');

let fflateSource = fs.readFileSync(fflatePath, 'utf8');
let parseExrSource = fs.readFileSync(parseExrPath, 'utf8');

// Remove all export statements from fflate and convert to object properties
fflateSource = fflateSource
  .replace(/^export var /gm, 'var ')
  .replace(/^export function /gm, 'function ')
  .replace(/^export \{ /gm, '// export { ')
  .replace(/^export default /gm, 'var _default = ');

// Remove the import statement from parse-exr
parseExrSource = parseExrSource
  .replace('import * as fflate from "fflate";', '// fflate loaded above')
  .replace('export default parseExr;', '// exported below');

// Create the bundled version
const bundled = `// Bundled parse-exr with fflate for browser
// Auto-generated by scripts/bundle-exr-fixed.mjs - do not edit manually

(function() {
'use strict';

// ========== FFLATE MODULE ==========
${fflateSource}

// Create fflate object with necessary exports for parse-exr
const fflate = {
  unzipSync: typeof unzipSync !== 'undefined' ? unzipSync : undefined,
  unzlibSync: typeof unzlibSync !== 'undefined' ? unzlibSync : undefined,
  strFromU8: typeof strFromU8 !== 'undefined' ? strFromU8 : undefined,
  inflateSync: typeof inflateSync !== 'undefined' ? inflateSync : undefined,
};

// ========== PARSE-EXR MODULE ==========
${parseExrSource}

// ========== GLOBAL EXPORTS ==========
window.parseExr = parseExr;
window.parseExrConstants = {
  FloatType: 1015,
  HalfFloatType: 1016,
  RGBAFormat: 1023,
  RedFormat: 1028,
  NoColorSpace: "",
  LinearSRGBColorSpace: "srgb-linear"
};

console.log('parse-exr library loaded successfully');
})();
`;

// Write the bundled file
const outputPath = path.join(__dirname, '../media/parse-exr.js');
fs.writeFileSync(outputPath, bundled, 'utf8');

console.log(`âœ“ Bundle created: ${outputPath}`);
console.log(`  Size: ${(bundled.length / 1024).toFixed(1)} KB`);
